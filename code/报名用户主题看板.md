# 报名用户主题看板



## 1.建模操作

### ODS层

意向用户主题看板已导入完成，此处无需进行。

### DIM层

意向用户主题看板已导入完成，此处无需进行。

### DWD层

```sql
CREATE TABLE IF NOT EXISTS DWD.`application_dwd` (
  `rid` int COMMENT 'id',
  `customer_id` STRING COMMENT '客户id',
  `create_date_time` STRING COMMENT '创建时间',
  `itcast_school_id` STRING COMMENT '校区id',
  `deleted` STRING COMMENT '是否被删除',
  `origin_type` STRING COMMENT '来源渠道',
  `itcast_subject_id` STRING COMMENT '学科id',
  `creator` int COMMENT '创建人',
  `payment_state` STRING COMMENT '支付状态',
  `payment_time` STRING COMMENT '支付时间',
  `department_id` STRING COMMENT '部门id',
  `hourinfo` STRING COMMENT '小时信息',
  `origin_type_stat` STRING COMMENT '数据来源:0.线下；1.线上'
    
)
comment '报名用户dwd表'
PARTITIONED BY(yearinfo STRING,monthinfo STRING,dayinfo STRING)
clustered by(rid) sorted by(rid) into 10 buckets
ROW FORMAT DELIMITED 
FIELDS TERMINATED BY '\t'
stored as ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');
```

### DWM层

```sql
CREATE TABLE IF NOT EXISTS DWM.`application_dwm` (
  `customer_id` STRING COMMENT 'id信息',
  `create_date_time` STRING COMMENT '创建时间',
  `itcast_school_id` STRING COMMENT '校区id',
  `itcast_school_name` STRING COMMENT '校区名称',
  `deleted` STRING COMMENT '是否被删除=false',
  `origin_type` STRING COMMENT '来源渠道',
  `itcast_subject_id` STRING COMMENT '学科id',
  `itcast_subject_name` STRING COMMENT '学科名称',
  `payment_state` STRING COMMENT '支付状态=paid',
  `payment_time` STRING COMMENT '支付时间',
  `hourinfo` STRING COMMENT '小时信息',
  `origin_type_stat` STRING COMMENT '数据来源:0.线下；1.线上',
  `department_id` STRING COMMENT '创建者部门id',
  `department_name` STRING COMMENT '部门名称'
)
comment '客户意向dwm表'
PARTITIONED BY(yearinfo STRING,monthinfo STRING,dayinfo STRING)
clustered by(customer_id) sorted by(customer_id) into 10 buckets
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
stored as ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');

```

### DWS层

```sql
CREATE TABLE IF NOT EXISTS DWS.`application_dws` (
  `customer_total` INT COMMENT '聚合报名客户数',
  `itcast_school_id` STRING COMMENT '校区id',
  `itcast_school_name` STRING COMMENT '校区名称',
  `origin_type` STRING COMMENT '来源渠道',
  `itcast_subject_id` STRING COMMENT '学科id',
  `itcast_subject_name` STRING COMMENT '学科名称',
  `payment_state` STRING COMMENT '支付状态',
  `payment_time` STRING COMMENT '支付时间',
  `hourinfo` STRING COMMENT '小时信息',
  `origin_type_stat` STRING COMMENT '数据来源:0.线下；1.线上',
  `department_id` STRING COMMENT '创建者部门id',
  `department_name` STRING COMMENT '咨询中心名称',
  `time_str` STRING COMMENT '时间明细',
  `group_type` STRING COMMENT '产品属性类别：1.总报名量；2.校区；3.学科；4.来源渠道；5.咨询中心;6.校区学科组合;7.已支付',
  `time_type` STRING COMMENT '时间维度：1、按小时聚合；2、按天聚合；3、按周聚合；4、按月聚合；5、按年聚合'
)
comment '客户意向dws表'
PARTITIONED BY(yearinfo STRING,monthinfo STRING,dayinfo STRING)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY '\t'
stored as ORC
TBLPROPERTIES ('orc.compress'='SNAPPY');
```

## 2.数据采集

原始数据前一主题已完成



## 3.清洗转换操作

### 生成DWD层数据

```sql
insert into table DWD.application_dwd partition(yearinfo,monthinfo,dayinfo)
select  
    id as rid,
    customer_id,
    create_date_time,
    itcast_school_id, 
    deleted,
    origin_type,
    itcast_subject_id,
    creator,
    payment_state,
    payment_time,
    substr(create_date_time,12,2) as hourinfo, 
    if(origin_type in('NETSERVICE','PRESIGNUP'),'1','0') as origin_type_stat,
    substr(create_date_time,1,4) as yearinfo,
    substr(create_date_time,6,2) as monthinfo,
    substr(create_date_time,9,2) as dayinfo 

from ODS.customer_relationship;
```

### 生成DWM层数据

```sql
insert into table DWM.application_dwm partition(yearinfo,monthinfo,dayinfo)
select  
    app.customer_id,
    app.create_date_time,
    app.itcast_school_id,
    sch.name as itcast_school_name,
    app.deleted,
    app.origin_type,
    app.itcast_subject_id,
    sub.name as itcast_subject_name,
    app.payment_state,
    app.payment_time,
    app.hourinfo,
    app.origin_type_stat,
    app.department_id,
    dept.name as department_name,
    app.yearinfo,
    app.monthinfo,
    app.dayinfo
from DWD.application_dwd  app
    left join DIM.itcast_subject sub on  app.itcast_subject_id = sub.id
    left join DIM.itcast_school sch  on app.itcast_school_id = sch.id
    left join DIM.scrm_department dept on app.department_id = dept.id;
```

### 生成DWS层数据

#### 基于时间统计报名客户总量

```sql
-- 统计每年 线上线下 的总报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	yearinfo as time_str,
	'1' as grouptype,
	'5' as time_type,
	yearinfo,
	'-1' as monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,origin_type_stat;

-- 统计每年每月 线上线下 的总报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo) as time_str,
	'1' as grouptype,
	'4' as time_type,
	yearinfo,
	monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,origin_type_stat;

-- 统计每年每月每天 线上线下 的总报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo,'-',dayinfo) as time_str,
	'1' as grouptype,
	'2' as time_type,
	yearinfo,
	monthinfo,
	dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,dayinfo,origin_type_stat;

```



#### 基于时间统计各校区报名量

```sql
-- 统计每年各校区报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	itcast_school_id,
	itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	yearinfo as time_str,
	'2' as grouptype,
	'5' as time_type,
	yearinfo,
	'-1' as monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,itcast_school_id,itcast_school_name;

-- 统计每年每月的各校区报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	itcast_school_id,
	itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo) as time_str,
	'2' as grouptype,
	'4' as time_type,
	yearinfo,
	monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,itcast_school_id,itcast_school_name;

-- 统计每年每月每天的各校区报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	itcast_school_id,
	itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo,'-',dayinfo) as time_str,
	'2' as grouptype,
	'2' as time_type,
	yearinfo,
	monthinfo,
	dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,dayinfo,itcast_school_id,itcast_school_name;
```



#### 基于时间统计各科目报名量

```sql
-- 统计每年各科目报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	itcast_subject_id,
	itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	yearinfo as time_str,
	'3' as grouptype,
	'5' as time_type,
	yearinfo,
	'-1' as monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,itcast_subject_id,itcast_subject_name;

-- 统计每年每月各科目报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	itcast_subject_id,
	itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo) as time_str,
	'3' as grouptype,
	'4' as time_type,
	yearinfo,
	monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,itcast_subject_id,itcast_subject_name;

-- 统计每年每月每天各科目报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	itcast_subject_id,
	itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo,'-',dayinfo) as time_str,
	'3' as grouptype,
	'2' as time_type,
	yearinfo,
	monthinfo,
	dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,dayinfo,itcast_subject_id,itcast_subject_name;
```

#### 基于时间统计各来源渠道报名量

```sql
-- 统计每年各来源渠道报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	yearinfo as time_str,
	'4' as grouptype,
	'5' as time_type,
	yearinfo,
	'-1' as monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,origin_type;

-- 统计每年每月各来源渠道报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo) as time_str,
	'4' as grouptype,
	'4' as time_type,
	yearinfo,
	monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,origin_type;

-- 统计每年每月每天各来源渠道报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo,'-',dayinfo) as time_str,
	'4' as grouptype,
	'2' as time_type,
	yearinfo,
	monthinfo,
	dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,dayinfo,origin_type;
```

#### 基于时间统计各咨询中心报名量

```sql
-- 统计每年各咨询中心报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	department_id,
	department_name,
	yearinfo as time_str,
	'5' as grouptype,
	'5' as time_type,
	yearinfo,
	'-1' as monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,department_id,department_name;

-- 统计每年每月各咨询中心报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	department_id,
	department_name,
	concat(yearinfo,'-',monthinfo) as time_str,
	'5' as grouptype,
	'4' as time_type,
	yearinfo,
	monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,department_id,department_name;

-- 统计每年每月每天各咨询中心报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	department_id,
	department_name,
	concat(yearinfo,'-',monthinfo,'-',dayinfo) as time_str,
	'5' as grouptype,
	'2' as time_type,
	yearinfo,
	monthinfo,
	dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,dayinfo,department_id,department_name;
```

#### 基于时间统计各校区学科组合报名量

```sql
-- 统计每年各校区学科组合报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	itcast_school_id,
	itcast_school_name,
	'-1' as origin_type,
	itcast_subject_id,
	itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	yearinfo as time_str,
	'6' as grouptype,
	'5' as time_type,
	yearinfo,
	'-1' as monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,itcast_school_id,itcast_school_name,itcast_subject_id,itcast_subject_name;

-- 统计每年每月各校区学科组合报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	itcast_school_id,
	itcast_school_name,
	'-1' as origin_type,
	itcast_subject_id,
	itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo) as time_str,
	'6' as grouptype,
	'4' as time_type,
	yearinfo,
	monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,itcast_school_id,itcast_school_name,itcast_subject_id,itcast_subject_name;

-- 统计每年每月每天各校区学科组合报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	itcast_school_id,
	itcast_school_name,
	'-1' as origin_type,
	itcast_subject_id,
	itcast_subject_name,
	'-1' as payment_state,
	'-1' as payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo,'-',dayinfo) as time_str,
	'6' as grouptype,
	'2' as time_type,
	yearinfo,
	monthinfo,
	dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,dayinfo,itcast_school_id,itcast_school_name,itcast_subject_id,itcast_subject_name;
```

#### 基于时间统计已支付报名量

```sql
-- 统计每年 已支付 的总报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	payment_state,
	payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	yearinfo as time_str,
	'7' as grouptype,
	'5' as time_type,
	yearinfo,
	'-1' as monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,payment_state,payment_time;

-- 统计每年每月 已支付 的总报名量
insert into table DWS.application_dws partition(yearinfo,monthinfo,dayinfo)
select 
	count( distinct customer_id) as customer_total, 
	'-1' as itcast_school_id,
	'-1' as itcast_school_name,
	'-1' as origin_type,
	'-1' as itcast_subject_id,
	'-1' as itcast_subject_name,
	payment_state,
	payment_time,
	'-1' as hourinfo,
	'-1' as origin_type_stat,
	'-1' as department_id,
	'-1' as department_name,
	concat(yearinfo,'-',monthinfo) as time_str,
	'7' as grouptype,
	'5' as time_type,
	yearinfo,
	monthinfo,
	'-1' as dayinfo
from DWM.application_dwm
group by yearinfo,monthinfo,payment_state,payment_time;


```





## 数据导出操作

```mysql
CREATE TABLE IF NOT EXISTS scrm_bi.`application` (
  `customer_total` INT COMMENT '聚合报名客户数',
  `itcast_school_id` varchar(100) COMMENT '校区id',
  `itcast_school_name` varchar(20) COMMENT '校区名称',
  `origin_type` varchar(100) COMMENT '来源渠道',
  `itcast_subject_id` varchar(20) COMMENT '学科id',
  `itcast_subject_name` varchar(20) COMMENT '学科名称',
  `payment_state` varchar(20) COMMENT '支付状态',
  `payment_time` varchar(20) COMMENT '支付时间',
  `hourinfo` varchar(20) COMMENT '小时信息',
  `origin_type_stat` varchar(20) COMMENT '数据来源:0.线下；1.线上',
  `department_id` varchar(20) COMMENT '创建者部门id',
  `department_name` varchar(20) COMMENT '咨询中心名称',
  `time_str` varchar(20) COMMENT '时间明细',
  `group_type` varchar(20) COMMENT '产品属性类别：1.总报名量；2.校区；3.学科；4.来源渠道；5.咨询中心;6.校区学科组合;7.已支付的',
  `time_type` varchar(20) COMMENT '时间维度：1、按小时聚合；2、按天聚合；3、按周聚合；4、按月聚合；5、按年聚合；',
    yearinfo varchar(20) COMMENT '年' ,
    monthinfo varchar(20) COMMENT '月',
    dayinfo varchar(20) COMMENT '日'
)
comment '客户意向dws表';
```

sqoop

```shell
sqoop export \
--connect "jdbc:mysql://192.168.52.150:3306/scrm_bi?useUnicode=true&characterEncoding=utf-8" \
--username root \
--password 123456 \
--table application \
--hcatalog-database dws \
--hcatalog-table application_dws \
--m 1
```

